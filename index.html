<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAGED MAESTRO: Real Book Edition v2.9</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Jazz Club Palette */
            --bg: #121214;
            --card: #1c1c1f;
            --primary: #c5a059; /* Brass Gold */
            --primary-dim: #8a6d3b;
            --text: #e0e0e0;
            --text-muted: #888888;
            --accent: #95353a; /* Velvet Red */
            --success: #4a8f6d; /* Muted Green */
            --info: #4a6fa5;   /* Muted Blue */
            
            --font-main: 'Montserrat', sans-serif;
            --font-serif: 'Playfair Display', serif;
            
            --radius: 12px;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 20px rgba(197, 160, 89, 0.15);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            background-image: radial-gradient(circle at 50% 0%, #2a2a30 0%, #0d0d0f 70%);
        }

        .container {
            background-color: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            width: 100%;
            max-width: 900px;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 0;
            margin-top: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
        }

        .content-wrap { flex: 1; }

        /* TYPOGRAPHY */
        .app-title {
            font-family: var(--font-serif);
            font-size: clamp(2.5rem, 8vw, 4rem); 
            font-weight: 900;
            letter-spacing: 1px;
            color: var(--primary);
            margin: 2rem 0 0.5rem 0;
            text-shadow: var(--shadow-glow);
            font-style: italic;
        }
        .app-subtitle {
            font-family: var(--font-main);
            font-size: 1rem;
            letter-spacing: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2rem;
        }

        /* DASHBOARD & STATS */
        .dashboard-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
            margin-bottom: 2rem; 
            padding: 0 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03); 
            padding: 15px; 
            border-radius: var(--radius); 
            border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--primary-dim); }
        .stat-label { font-size: 0.7rem; color: var(--primary); letter-spacing: 1px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; font-family: var(--font-main); }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: #fff; font-family: var(--font-serif); }
        .stat-val.gold { color: var(--primary); text-shadow: 0 0 10px rgba(197,160,89,0.3); }

        .rank-progress-container { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .rank-progress-bar { height: 100%; background: var(--primary); transition: width 0.5s ease; }
        .rank-next-info { font-size: 0.6rem; color: #666; margin-top: 4px; }

        .streak-badge {
            position: absolute; top: 10px; right: 20px;
            display: flex; align-items: center; gap: 5px;
            background: rgba(197, 160, 89, 0.1); padding: 5px 12px; border-radius: 20px;
            border: 1px solid var(--primary-dim);
        }
        .streak-count { font-weight: bold; color: var(--primary); }

        /* BUTTONS */
        .btn { 
            border: none; border-radius: 50px; cursor: pointer; font-weight: 600; margin: 8px; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            position: relative; overflow: hidden; font-family: var(--font-main); letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { 
            background: var(--primary); color: #000; padding: 1rem 3rem; font-size: 1.1rem; 
            box-shadow: 0 5px 20px rgba(197, 160, 89, 0.2);
        }
        .btn-primary:hover { background: #d4b06a; box-shadow: 0 8px 25px rgba(197, 160, 89, 0.3); transform: translateY(-2px); }
        .btn-secondary { background: transparent; color: var(--text-muted); padding: 0.6rem 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .btn-secondary:hover { border-color: var(--text); color: var(--text); background: rgba(255,255,255,0.05); }
        .btn-special {
            background: linear-gradient(135deg, #2a2a30 0%, #1c1c1f 100%);
            border: 1px solid rgba(255,255,255,0.1); color: var(--primary); padding: 0.8rem 2rem;
        }
        .btn-special:hover { border-color: var(--primary); box-shadow: 0 0 15px rgba(197,160,89,0.1); }
        .btn-icon { background: transparent; color: var(--text-muted); font-size: 1.2rem; padding: 8px; border-radius: 50%; }
        .btn-icon:hover { color: var(--primary); background: rgba(197, 160, 89, 0.1); }
        .btn-toggle { background: #161618; border: 1px solid #333; color: #666; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; }
        .btn-toggle.active { background: #1c1c1f; border-color: var(--success); color: var(--success); }

        /* SELECTORS */
        .selector-section { margin: 20px 20px; text-align: left; position: relative; }
        .section-label { color: var(--primary-dim); font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .grid-select { display: grid; gap: 8px; }
        .grid-6 { grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .select-item { 
            background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #666; padding: 10px 5px; border-radius: 8px; 
            font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center;
        }
        .select-item:hover { background: rgba(255,255,255,0.05); color: #bbb; }
        .select-item.active { background: rgba(197, 160, 89, 0.1); border-color: var(--primary); color: var(--primary); font-weight: bold; }

        /* DAILY MISSION */
        .daily-mission-box {
            background: linear-gradient(90deg, rgba(74, 111, 165, 0.1) 0%, transparent 100%);
            border-left: 3px solid var(--info);
            margin: 0 20px 20px 20px; padding: 15px; text-align: left;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 4px;
        }
        .mission-title { font-size: 0.75rem; color: var(--info); font-weight: bold; margin-bottom: 4px; letter-spacing: 1px;}
        .mission-desc { font-size: 0.9rem; font-family: var(--font-main); font-weight: bold; }
        .mission-progress { font-family: var(--font-main); font-size: 0.8rem; color: #666; font-weight: bold; }
        .mission-complete { color: var(--success); }

        /* GAME UI */
        .game-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
            background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        .rank-display { font-family: var(--font-serif); font-weight: 700; color: var(--primary); font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .score-live { font-family: var(--font-serif); font-size: 1.8rem; font-weight: 700; color: #fff; }
        .combo-live { text-align: right; }
        .combo-val { font-size: 1.2rem; font-weight: 900; color: #d946ef; display: block; line-height: 1; }
        .combo-label { font-size: 0.6rem; color: #fff; background: rgba(217, 70, 239, 0.2); padding: 2px 6px; border-radius: 3px; }

        .mission-display {
            background: #161618; padding: 1.5rem; margin: 1rem 20px; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05);
            position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        }
        .chord-main { font-family: var(--font-serif); font-size: 3.5rem; font-weight: 400; color: #fff; line-height: 1; margin: 10px 0; }
        .target-sub { font-size: 1.5rem; color: var(--accent); font-weight: 700; margin-top: 10px; font-family: var(--font-serif); font-style: italic; }
        .target-sub span { color: var(--text-muted); font-size: 0.9rem; font-family: var(--font-main); font-style: normal; font-weight: normal; margin-right: 10px;}
        .theory-tip { margin-top: 15px; padding: 10px; background: rgba(74, 111, 165, 0.1); border-radius: 6px; color: #a0aec0; font-size: 0.8rem; text-align: left; display: flex; align-items: center; gap: 10px; }
        .song-progress-wrap { margin-bottom: 15px; }
        .song-info-bar { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .song-progress-track { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .song-progress-fill { height: 100%; background: var(--info); transition: width 0.3s ease; }
        .next-chord { margin-top: 15px; font-size: 0.9rem; color: #666; font-style: italic; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
        .next-chord span { color: #fff; font-weight: bold; font-family: var(--font-serif); margin-left: 5px; }

        /* REALISTIC FRETBOARD STYLES */
        .fretboard-wrap { 
            width: 100%; overflow: hidden; background: #000; 
            border-top: 2px solid #111; border-bottom: 2px solid #111;
            padding: 0; margin-bottom: 1rem; cursor: pointer; display: flex; justify-content: center;
            position: relative; /* Ensure context for absolute children if needed */
            z-index: 1;
        }
        .responsive-svg { width: 100%; height: auto; max-width: 760px; display: block; }
        .interactive-dot { transition: all 0.2s; cursor: pointer; }
        .interactive-dot:hover { stroke: white; stroke-width: 2px; filter: drop-shadow(0 0 5px var(--primary)); }
        
        /* OVERLAYS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); padding: 20px; }
        .modal-box { 
            background: #1c1c1f; width: 100%; max-width: 600px; max-height: 85vh; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        .modal-header { padding: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: #222; }
        .modal-body { padding: 1.5rem; overflow-y: auto; text-align: left; }
        .modal-title { margin: 0; color: var(--primary); font-family: var(--font-serif); font-size: 1.4rem; }
        
        /* IN-GAME RANK UP FLASH EFFECT (FIXED Z-INDEX ISSUE) */
        .ingame-rank-overlay {
            position: fixed; /* Changed to fixed to cover entire screen */
            top: 0; left: 0; width: 100%; height: 100vh;
            pointer-events: none; /* Clicks pass through */
            z-index: 300; /* Ultra-high z-index to be on top of everything */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .flash-text {
            font-family: var(--font-serif); font-weight: 900; color: #fff;
            text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary);
            animation: flashAnim 2.5s ease-out forwards;
        }
        .flash-title { font-size: 4rem; color: var(--primary); margin-bottom: 10px; line-height: 1; }
        .flash-sub { font-size: 2rem; color: #fff; letter-spacing: 5px; text-transform: uppercase; }
        
        @keyframes flashAnim {
            0% { transform: scale(0.5); opacity: 0; filter: blur(20px); }
            10% { transform: scale(1.2); opacity: 1; filter: blur(0); }
            20% { transform: scale(1.0); }
            80% { opacity: 1; transform: scale(1.0); }
            100% { opacity: 0; transform: scale(1.5); filter: blur(10px); }
        }

        .help-section { margin-bottom: 2rem; }
        .help-section h3 { color: #fff; border-bottom: 1px solid var(--primary-dim); padding-bottom: 8px; font-size: 1.1rem; margin-bottom: 15px; font-family: var(--font-serif); letter-spacing: 1px; }
        .help-section p, .help-section li { color: #aaa; font-size: 0.9rem; line-height: 1.6; margin-bottom: 8px; }
        .help-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; color: #ccc; margin-top: 10px; }
        .help-table th, .help-table td { border: 1px solid #444; padding: 8px 12px; text-align: left; }
        .help-table th { background: rgba(197, 160, 89, 0.1); color: var(--primary); font-weight: bold; width: 30%; }
        .key-badge { background: #333; padding: 2px 6px; border-radius: 4px; border: 1px solid #555; font-family: monospace; color: #fff; font-weight: bold; display: inline-block; min-width: 20px; text-align: center; }

        .search-box { width: 100%; padding: 12px 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-family: var(--font-main); font-size: 1rem; outline: none; margin-bottom: 15px; transition: border-color 0.3s; }
        .search-box:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        .song-list-container { max-height: 60vh; overflow-y: auto; padding-right: 5px; }
        
        .feedback-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); z-index: 50; backdrop-filter: blur(2px); border-radius: 1rem; pointer-events: none; }
        .fb-text { font-family: var(--font-serif); font-size: 4rem; font-weight: 700; color: #fff; text-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: popIn 0.3s ease-out; }
        .fb-sub { background: var(--bg); color: var(--primary); padding: 5px 20px; border-radius: 20px; margin-top: 10px; border: 1px solid var(--primary); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .rank-up-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; cursor: pointer; }
        .god-rays { position: absolute; top: 50%; left: 50%; width: 200vmax; height: 200vmax; background: conic-gradient(from 0deg, transparent 0deg, rgba(197, 160, 89, 0.2) 20deg, transparent 40deg, rgba(197, 160, 89, 0.2) 60deg, transparent 80deg); transform: translate(-50%, -50%); animation: rotateRays 20s linear infinite; pointer-events: none; }
        .rank-up-content { z-index: 201; text-align: center; animation: zoomInBounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .rank-up-label { font-family: var(--font-serif); font-size: 3rem; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.5); letter-spacing: 5px; margin-bottom: 20px; }
        .rank-up-name { font-family: var(--font-serif); font-size: 5rem; font-weight: 900; background: linear-gradient(135deg, #fff 0%, var(--primary) 50%, #fff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 50px var(--primary-dim); margin-bottom: 10px; }
        .rank-up-sub { color: #888; letter-spacing: 2px; text-transform: uppercase; font-size: 0.9rem; margin-top: 30px; animation: pulse 2s infinite; }
        @keyframes rotateRays { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes zoomInBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .help-mark { display: inline-block; width: 14px; height: 14px; line-height: 14px; background: #444; color: #fff; border-radius: 50%; font-size: 10px; text-align: center; cursor: help; margin-left: 5px; }
        .help-mark:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #222; padding: 5px 10px; border-radius: 4px; border: 1px solid #444; width: max-content; max-width: 200px; font-size: 0.7rem; color: #eee; z-index: 10; text-transform: none; font-weight: normal; margin-bottom: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .app-footer { padding: 1.5rem; text-align: center; font-size: 0.75rem; color: #444; border-top: 1px solid rgba(255,255,255,0.02); margin-top: auto; }
        .text-sm { font-size: 0.8rem; color: #888; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        
        .tab-nav { display: flex; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 1rem; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #666; padding: 12px; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; font-family: var(--font-main); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(197, 160, 89, 0.05); }

        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .badge-item { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; text-align: center; opacity: 0.2; filter: grayscale(1); transition: all 0.5s; }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0); background: linear-gradient(135deg, rgba(197, 160, 89, 0.1) 0%, transparent 100%); border: 1px solid var(--primary-dim); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .summary-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
        .summary-label { font-size: 0.7rem; color: #888; display: block; }
        .summary-value { font-size: 1.1rem; color: #fff; font-weight: bold; font-family: var(--font-serif); }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="content-wrap">
        <div v-if="currentView === 'title'" style="padding: 1rem;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn btn-icon" @click="showHelp = true">‚ùì</button>
                <div class="streak-badge" v-if="stats.loginStreak > 1">
                    <span>üî•</span>
                    <span class="streak-count">{{ stats.loginStreak }} Day Streak</span>
                </div>
                <button class="btn btn-icon" @click="showSettings = true">‚öôÔ∏è</button>
            </div>

            <h1 class="app-title">CAGED<br>MAESTRO</h1>
            <div class="app-subtitle">ABSOLUTE JAZZ THEORY</div>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <span class="stat-label">Total Score</span>
                    <span class="stat-val">{{ stats.totalScore.toLocaleString() }}</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Reputation</span>
                    <span class="stat-val gold">{{ currentRankInfo.name }}</span>
                    <div class="rank-progress-container">
                        <div class="rank-progress-bar" :style="{width: currentRankInfo.progress + '%'}"></div>
                    </div>
                    <div class="rank-next-info">Next: {{ currentRankInfo.nextReq.toLocaleString() }} pts</div>
                </div>
                <div class="stat-card" @click="showAchievements = true" style="cursor:pointer;">
                    <span class="stat-label">Awards</span>
                    <span class="stat-val">{{ unlockedBadgeCount }} / {{ achievements.length }}</span>
                </div>
            </div>

            <div class="daily-mission-box" v-if="dailyMission">
                <div>
                    <div class="mission-title">‰ªäÂ§ú„ÅÆ„ÇÆ„Ç∞ („Éá„Ç§„É™„Éº)</div>
                    <div class="mission-desc">{{ dailyMission.desc }}</div>
                </div>
                <div :class="['mission-progress', { 'mission-complete': dailyMission.progress >= dailyMission.goal }]">
                    {{ dailyMission.progress }} / {{ dailyMission.goal }}
                </div>
            </div>

            <div style="margin-bottom: 2rem; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button v-if="srsDueCount > 0" class="btn btn-primary" style="background: var(--accent); color:#fff; box-shadow: 0 5px 20px rgba(149, 53, 58, 0.4);" @click="startGame('srs')">
                    üß† Âæ©Áøí„Åô„Çã ({{ srsDueCount }})
                </button>
                <div v-else-if="stats.mistakeLog.length > 0" style="color:#666; font-size:0.8rem; font-style:italic; padding: 1rem;">
                    Excellent! Âæ©ÁøíÂØæË±°„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                </div>

                <button class="btn btn-special" @click="showSongSelect = true">
                    üìñ Gig Mode (Real Book)
                </button>
            </div>

            <div class="selector-section">
                <div class="section-label">Key <span style="font-weight:normal; opacity:0.5; text-transform:none;">(Shift+K to toggle)</span></div>
                <div class="grid-select grid-6">
                    <div class="select-item" :class="{active: selectedKey === 'ALL'}" @click="selectedKey = 'ALL'">ALL</div>
                    <div v-for="k in keysList" :key="k" class="select-item" :class="{active: selectedKey === k}" @click="selectedKey = k">{{ k }}</div>
                </div>
            </div>

            <div class="selector-section">
                <div class="section-label">Shape <span class="help-mark" data-tooltip="Á∑¥Áøí„Åó„Åü„ÅÑCAGED„Éï„Ç©„Éº„É†„ÇíÈÅ∏Êäû„Åó„Åæ„Åô">?</span></div>
                <div class="grid-select grid-6">
                    <div class="select-item" :class="{active: selectedShape === 'ALL'}" @click="selectedShape = 'ALL'">ALL</div>
                    <div v-for="s in ['C','A','G','E','D']" :class="['select-item', {active: selectedShape === s}]" @click="selectedShape = s">{{ s }}</div>
                </div>
            </div>

            <div class="selector-section">
                <div class="section-label">Difficulty</div>
                <div class="grid-select grid-3">
                    <div class="select-item" :class="{active: difficulty === 'easy'}" @click="difficulty = 'easy'">üî∞ Easy</div>
                    <div class="select-item" :class="{active: difficulty === 'normal'}" @click="difficulty = 'normal'">Normal</div>
                    <div class="select-item" :class="{active: difficulty === 'hard'}" @click="difficulty = 'hard'">Hard</div>
                </div>
            </div>

            <button class="btn btn-primary" @click="startGame('normal')">Start Session</button>
            <div style="margin-top: 1rem;">
                <button class="btn btn-secondary" @click="openAnalysis">üìä Analysis</button>
            </div>
        </div>

        <div v-if="showSongSelect" class="modal-overlay" @click.self="showSongSelect = false">
            <div class="modal-box">
                <div class="modal-header">
                    <h2 class="modal-title">üìñ Real Book ({{ filteredSongs.length }})</h2>
                    <button class="btn-icon" @click="showSongSelect = false">‚úï</button>
                </div>
                <div class="modal-body" style="padding-top: 0;">
                    <div style="position:sticky; top:0; background:#1c1c1f; padding-top:1.5rem; z-index:10;">
                        <input type="text" v-model="searchQuery" class="search-box" placeholder="Search Standards... (e.g. 'Autumn', 'Fly')">
                    </div>
                    <div class="song-list-container">
                        <div class="grid-select" style="grid-template-columns: 1fr;">
                            <div v-for="song in filteredSongs" :key="song.id" class="select-item" style="text-align:left; padding:15px; display:flex; justify-content:space-between; align-items:center;" @click="startSongMode(song)">
                                <div style="overflow:hidden;">
                                    <div style="color:#fff; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ song.title }}</div>
                                    <div style="font-size:0.75rem; color:#888;">Key: {{ song.key }} / {{ song.chords.length }} Chords</div>
                                </div>
                                <span style="font-size:1.2rem; color:var(--primary);">‚ñ∂</span>
                            </div>
                            <div v-if="filteredSongs.length === 0" style="padding:20px; color:#666; font-style:italic;">No songs found matching "{{ searchQuery }}"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else-if="currentView === 'game'">
            <div class="game-header">
                <div class="rank-display">
                    <span style="font-size:1.2rem; color:#fff;">üé∑</span>
                    <span>{{ currentRankInfo.name }}</span>
                </div>
                <div class="score-live">{{ sessionScore.toLocaleString() }}</div>
                <div class="combo-live" v-if="combo > 0">
                    <span class="combo-val">{{ combo }}</span>
                    <span class="combo-label">GROOVE x{{ comboMultiplier }}</span>
                </div>
            </div>

            <div style="height:4px; background:rgba(255,255,255,0.1); width:100%;">
                <div :style="{width: timerWidth + '%', height:'100%', background: timerColor, transition:'width 0.1s linear'}"></div>
            </div>

            <div class="mission-display">
                <div v-if="ingameRankUp" class="ingame-rank-overlay">
                    <div class="flash-text">
                        <div class="flash-title">RANK UP!</div>
                        <div class="flash-sub">{{ currentRankInfo.name }}</div>
                    </div>
                </div>

                <div v-if="gameMode === 'song'" class="song-progress-wrap">
                    <div class="song-info-bar">
                        <span>{{ currentSong.title }}</span>
                        <span>Bar {{ songIndex + 1 }} / {{ currentSong.chords.length }}</span>
                    </div>
                    <div class="song-progress-track">
                        <div class="song-progress-fill" :style="{width: ((songIndex + 1) / currentSong.chords.length * 100) + '%'}"></div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; color:#666; font-size:0.7rem; font-weight:bold; letter-spacing:1px; margin-bottom:10px;">
                    <span>TARGET CHORD</span>
                    <span v-if="gameMode !== 'song'">KEY: {{ currentQuestion.keyInfo }}</span>
                </div>
                
                <div class="chord-main">{{ currentQuestion.chordName }}</div>
                <div class="target-sub"><span>„Çø„Éº„Ç≤„ÉÉ„Éà:</span> {{ currentQuestion.targetDegreeName }}</div>
                
                <div v-if="gameMode === 'song' && nextChordName" class="next-chord">
                    Next: <span>{{ nextChordName }}</span>
                </div>
                
                <div v-if="settings.showTheory && theoryTip" class="theory-tip">
                    <span style="font-size:1.2rem;">üí°</span>
                    <span>{{ theoryTip }}</span>
                </div>

                <div v-if="feedback.msg" class="feedback-overlay">
                    <div class="fb-text" :style="{color: feedback.color}">{{ feedback.msg }}</div>
                    <div class="fb-sub">{{ feedback.sub }}</div>
                </div>
            </div>

            <div class="fretboard-wrap">
                <svg viewBox="0 0 760 230" preserveAspectRatio="xMidYMid meet" class="responsive-svg">
                    <defs>
                        <linearGradient id="fretGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#555;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#ddd;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#555;stop-opacity:1" />
                        </linearGradient>
                        <radialGradient id="inlayGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                            <stop offset="0%" style="stop-color:#fff;stop-opacity:0.9" />
                            <stop offset="100%" style="stop-color:#ccc;stop-opacity:0.6" />
                        </radialGradient>
                    </defs>

                    <rect x="0" y="0" width="760" height="230" fill="#2c1b18" />
                    
                    <rect v-for="i in 16" :key="'f'+i" :x="i * 45 - 2" y="10" width="4" height="180" fill="url(#fretGradient)" />
                    
                    <rect v-if="displayRange.min === 0" x="0" y="10" width="10" height="180" fill="#e8e6d1" />
                    
                    <g v-for="i in 16" :key="'mk'+i">
                        <circle v-if="[3,5,7,9,15,17,19,21].includes(i + displayRange.min - 1)" 
                                :cx="i * 45 - 22.5" cy="100" r="6" fill="url(#inlayGradient)" />
                        <g v-if="[12, 24].includes(i + displayRange.min - 1)">
                            <circle :cx="i * 45 - 22.5" cy="55" r="6" fill="url(#inlayGradient)" />
                            <circle :cx="i * 45 - 22.5" cy="145" r="6" fill="url(#inlayGradient)" />
                        </g>
                    </g>
            
                    <line v-for="(s, index) in 6" :key="'shad'+index" x1="0" :y1="32 + index * 28" x2="760" :y2="32 + index * 28" stroke="rgba(0,0,0,0.5)" :stroke-width="index * 0.6 + 1" />
                    <line v-for="(s, index) in 6" :key="'str'+index" x1="0" :y1="30 + index * 28" x2="760" :y2="30 + index * 28" :stroke="index < 2 ? '#d0d0d0' : '#a0a0a0'" :stroke-width="index * 0.5 + 1" />
            
                    <g v-for="k in 16" :key="'lbl'+k">
                        <text v-if="k===1 && displayRange.min===0" :x="10" y="220" text-anchor="middle" fill="#c5a059" font-size="14" font-family="Montserrat" font-weight="bold">0</text>
                        <text v-else :x="k * 45 - 22.5" y="220" text-anchor="middle" fill="#888" font-size="12" font-family="Montserrat">
                            {{ k + displayRange.min - 1 }}
                        </text>
                    </g>
            
                    <g v-for="(dot, idx) in fretboardDots" :key="'dot'+idx">
                        <circle v-if="(dot.isRoot && difficulty === 'easy') || (dot.isTarget && revealed)" 
                                :cx="(dot.fret - displayRange.min + 1) * 45 - 22.5" 
                                :cy="30 + dot.string * 28" 
                                :r="14" 
                                :fill="dot.isTarget ? 'rgba(239, 68, 68, 0.4)' : 'rgba(197, 160, 89, 0.4)'" />
                        
                        <circle :cx="(dot.fret - displayRange.min + 1) * 45 - 22.5" 
                                :cy="30 + dot.string * 28" 
                                :r="dot.r" 
                                :fill="dot.fill" 
                                :stroke="dot.stroke" 
                                :stroke-width="dot.strokeWidth || 2" 
                                class="interactive-dot" 
                                @click="handleShot(dot)" />
                        
                        <text v-if="dot.showLabel" :x="(dot.fret - displayRange.min + 1) * 45 - 22.5" :y="30 + dot.string * 28 + 4" text-anchor="middle" :fill="dot.textFill" font-size="10px" font-family="Montserrat" font-weight="bold" pointer-events="none">{{ dot.degree }}</text>
                    </g>
                </svg>
            </div>

            <div style="text-align:center;">
                <button class="btn btn-secondary" @click="endSession">End Session (ESC)</button>
            </div>
        </div>

        <div v-if="showRankUp" class="rank-up-overlay" @click="showRankUp = false">
            <div class="god-rays"></div>
            <div class="rank-up-content">
                <div class="rank-up-label">RANK UP!</div>
                <div class="rank-up-name">{{ currentRankInfo.name }}</div>
                <div style="font-size:2rem;">‚≠ê‚≠ê‚≠ê</div>
                <div class="rank-up-sub">Click to Continue</div>
            </div>
        </div>

        <div v-if="showHelp" class="modal-overlay" @click.self="showHelp = false">
            <div class="modal-box">
                <div class="modal-header">
                    <h2 class="modal-title">üìì Training Manual</h2>
                    <button class="btn-icon" @click="showHelp = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h3>1. Concept</h3>
                        <p>Êú¨„Ç¢„Éó„É™„ÅØ„ÄåCAGED„Ç∑„Çπ„ÉÜ„É†„Äç„ÇíÁî®„ÅÑ„ÄÅÊåáÊùø‰∏ä„ÅÆ„Ç≥„Éº„Éâ„Éà„Éº„É≥ÔºàÊßãÊàêÈü≥Ôºâ„ÇíÁû¨ÊôÇ„Å´Ë¶ñË¶öÂåñ„Åô„Çã„Éà„É¨„Éº„Éã„É≥„Ç∞„ÉÑ„Éº„É´„Åß„Åô„ÄÇ„Ç∏„É£„Ç∫„ÅÆ„Ç¢„Éâ„É™„Éñ„Å´„Åä„ÅÑ„Å¶„ÄÅ„Ç≥„Éº„Éâ„ÅÆËâ≤ÂΩ©„ÇíÊ±∫„ÇÅ„Çã<b>3rd</b>„ÇÑ<b>7th</b>„ÇíÂç≥Â∫ß„Å´ÁâπÂÆö„Åô„ÇãËÉΩÂäõ„ÇíÈ§ä„ÅÑ„Åæ„Åô„ÄÇ</p>
                    </div>

                    <div class="help-section">
                        <h3>2. Game Modes</h3>
                        <table class="help-table">
                            <tr><th>Normal</th><td>„É©„É≥„ÉÄ„É†„Å™„Ç≠„Éº„Éª„Ç≥„Éº„ÉâÈÄ≤Ë°å„ÅßÂü∫Á§éÂäõ„ÇíÈçõ„Åà„Åæ„Åô„ÄÇ</td></tr>
                            <tr><th>Gig Mode</th><td>„ÄåÊûØËëâ„Äç„Å™„Å©ÂÆüÈöõ„ÅÆ„Çπ„Çø„É≥„ÉÄ„Éº„ÉâÊõ≤„ÅÆÈÄ≤Ë°å„ÅßÂÆüË∑µÁ∑¥Áøí„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇÂÆåËµ∞„Åß„Éú„Éº„Éä„Çπ„Çπ„Ç≥„Ç¢Áç≤Âæó„ÄÇ</td></tr>
                            <tr><th>SRS (Âæ©Áøí)</th><td>ÁßëÂ≠¶ÁöÑ„Å™„ÄåÈñìÈöîÂèçÂæ©„Äç„Ç∑„Çπ„ÉÜ„É†„ÄÇÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÅØ‰ª•‰∏ã„ÅÆ„Çµ„Ç§„ÇØ„É´„ÅßÂÜçÂá∫È°å„Åï„Çå„Åæ„Åô„ÄÇ<br>
                            <span style="font-size:0.75rem; color:#888;">(10ÂàÜÂæå ‚Üí 4ÊôÇÈñìÂæå ‚Üí 12ÊôÇÈñìÂæå ‚Üí 1Êó•Âæå ‚Üí 3Êó•Âæå ‚Üí ÂÆå‰∫Ü)</span></td></tr>
                        </table>
                    </div>

                    <div class="help-section">
                        <h3>3. Controls & Shortcuts</h3>
                        <table class="help-table">
                            <tr><th><span class="key-badge">ESC</span></th><td>„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Å¶Êàª„Çã</td></tr>
                            <tr><th><span class="key-badge">Shift</span>+<span class="key-badge">K</span></th><td>Âá∫È°å„Ç≠„Éº„ÅÆÂõ∫ÂÆö/Ëß£Èô§ (Toggle)</td></tr>
                            <tr><th><span class="key-badge">H</span></th><td>„Éí„É≥„ÉàË°®Á§∫ („É´„Éº„ÉàÈü≥„ÇíÂº∑Ë™ø / Easy„ÅÆ„Åø)</td></tr>
                            <tr><th><span class="key-badge">N</span></th><td>Ê¨°„ÅÆ„Ç≥„Éº„Éâ„Å∏„Çπ„Ç≠„ÉÉ„Éó (Song Mode„ÅÆ„Åø)</td></tr>
                        </table>
                    </div>

                    <div class="help-section">
                        <h3>4. Interface & Settings</h3>
                        <p>ÁîªÈù¢Âè≥‰∏ä„ÅÆ ‚öôÔ∏è „Ç¢„Ç§„Ç≥„É≥„Åã„ÇâË®≠ÂÆö„É°„Éã„É•„Éº„ÇíÈñã„Åë„Åæ„Åô„ÄÇ</p>
                        <table class="help-table">
                            <tr><th>üîä Sound FX</th><td>Ê≠£Ëß£Èü≥„Éª„Éü„ÇπÈü≥„ÅÆON/OFFÂàá„ÇäÊõø„Åà</td></tr>
                            <tr><th>üí° Theory Tips</th><td>„Ç≥„Éº„ÉâÊßãÊàêÈü≥„ÅÆËß£Ë™¨Ë°®Á§∫ON/OFF</td></tr>
                            <tr><th>‚è≥ Timer</th><td>Âà∂ÈôêÊôÇÈñì„ÅÆÊúâÁÑ° (Normal/Hard„ÅÆ„Åø)</td></tr>
                            <tr><th>üíæ Data</th><td>„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó(Backup)„Å®Ë™≠„ÅøËæº„Åø(Import)„ÄÅÂàùÊúüÂåñ(Reset)</td></tr>
                        </table>
                    </div>

                    <div class="help-section">
                        <h3>5. Theory Reference</h3>
                        <p>„Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Å™„ÇãÂ∫¶Êï∞ÔºàIntervalÔºâ„ÅÆÊÑèÂë≥‰∏ÄË¶ß„Åß„Åô„ÄÇ</p>
                        <table class="help-table">
                            <tr><th>M3 (3)</th><td>„É°„Ç∏„É£„Éº„Ç≥„Éº„Éâ„ÅÆÊòé„Çã„Åï„ÇíÊ±∫ÂÆö„Å•„Åë„ÇãÈü≥</td></tr>
                            <tr><th>m3 (b3)</th><td>„Éû„Ç§„Éä„Éº„Ç≥„Éº„Éâ„ÅÆÊöó„Åï„ÇíÊ±∫ÂÆö„Å•„Åë„ÇãÈü≥</td></tr>
                            <tr><th>M7 (7)</th><td>ÈÉΩ‰ºöÁöÑ„ÅßÊ¥óÁ∑¥„Åï„Çå„ÅüÈüø„Åç (Major 7th)</td></tr>
                            <tr><th>m7 (b7)</th><td>„Éñ„É´„Éº„Ç∏„Éº„Åß‰∏çÂÆâÂÆö„Å™Èüø„Åç (Dominant / Minor)</td></tr>
                            <tr><th>P5 (5)</th><td>„Ç≥„Éº„Éâ„ÅÆÈ™®Ê†º„ÉªÂÆâÂÆöÊÑü</td></tr>
                            <tr><th>b5 (#11)</th><td>Á∑äÂºµÊÑü„ÅÆ„ÅÇ„Çã„Éñ„É´„Éº„Éé„Éº„Éà„ÄÅ„Åæ„Åü„ÅØ„É™„Éá„Ç£„Ç¢„É≥Á≥ª</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showAnalysis" class="modal-overlay" @click.self="showAnalysis = false">
            <div class="modal-box">
                <div class="modal-header">
                    <h2 class="modal-title">üìä Session Analysis</h2>
                    <button class="btn-icon" @click="showAnalysis = false">‚úï</button>
                </div>
                <div class="tab-nav">
                    <button class="tab-btn" :class="{active: analysisTab === 'stats'}" @click="analysisTab = 'stats'">History</button>
                    <button class="tab-btn" :class="{active: analysisTab === 'weakness'}" @click="analysisTab = 'weakness'">Weakness</button>
                    <button class="tab-btn" :class="{active: analysisTab === 'heatmap'}" @click="analysisTab = 'heatmap'">Heatmap</button>
                </div>
                <div class="modal-body">
                    <div v-if="analysisTab === 'stats'">
                        <div class="summary-grid">
                             <div class="summary-item">
                                <span class="summary-label">Avg. Accuracy</span>
                                <span class="summary-value">{{ statsOverview.avgAccuracy }}%</span>
                            </div>
                             <div class="summary-item">
                                <span class="summary-label">Songs Cleared</span>
                                <span class="summary-value">{{ statsOverview.totalSongs }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Attempts</span>
                                <span class="summary-value">{{ statsOverview.totalAttempts }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Play Count</span>
                                <span class="summary-value">{{ statsOverview.totalSessions }}</span>
                            </div>
                        </div>

                        <canvas id="scoreChart" height="200"></canvas>
                        <div style="margin-top:20px;">
                            <div v-for="(log, i) in playHistory.slice(0, 5)" :key="i" class="row" style="border-bottom:1px solid rgba(255,255,255,0.05); padding:8px 0;">
                                <span class="text-sm">{{ log.date }}</span>
                                <div style="text-align:right;">
                                    <div style="font-family:var(--font-serif); color:#fff;">{{ log.score.toLocaleString() }} pts</div>
                                    <div style="font-size:0.7rem; color:#666;" v-if="log.accuracy">Acc: {{ log.accuracy }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="analysisTab === 'weakness'">
                        <div style="display:flex; gap:20px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:200px;">
                                <h4 style="text-align:center; color:#888; font-size:0.8rem;">Degree Accuracy</h4>
                                <canvas id="degreeChart" height="200"></canvas>
                            </div>
                            <div style="flex:1; min-width:200px;">
                                <h4 style="text-align:center; color:#888; font-size:0.8rem;">Shape Mastery</h4>
                                <canvas id="shapeChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <h4 style="text-align:center; color:#888; font-size:0.8rem;">Fretboard Accuracy Heatmap</h4>
                        <p style="font-size:0.7rem; color:#666; text-align:center; margin-bottom:10px;">Ëµ§=„Éü„ÇπÂ§öÁô∫ / Á∑ë=Ê≠£Á¢∫ / Èªí=„Éá„Éº„Çø„Å™„Åó</p>
                        <div style="display:flex; flex-direction:column-reverse; gap:5px;">
                            <div v-for="s in 6" :key="s" style="display:flex; gap:2px; align-items:center;">
                                <span style="width:20px; font-size:0.6rem; color:#555;">{{s}}</span>
                                <div v-for="seg in 5" :key="seg" :style="{
                                    flex:1, height:'20px', background: getHeatmapColor(s-1, seg),
                                    borderRadius:'2px', border: '1px solid rgba(0,0,0,0.3)'
                                }"></div>
                            </div>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:5px; padding-left:25px;">
                            <span style="font-size:0.6rem; color:#555;">Low Frets (0-3)</span>
                            <span style="font-size:0.6rem; color:#555;">High Frets (12+)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showSettings" class="modal-overlay" @click.self="showSettings = false">
            <div class="modal-box" style="max-width:400px;">
                <div class="modal-header">
                    <h2 class="modal-title">‚öôÔ∏è Settings</h2>
                    <button class="btn-icon" @click="showSettings = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <span>üîä Sound FX</span>
                        <button class="btn-toggle" :class="{active: settings.sound}" @click="settings.sound = !settings.sound">{{ settings.sound ? 'ON' : 'OFF' }}</button>
                    </div>
                    <div class="row">
                        <span>üí° Theory Tips</span>
                        <button class="btn-toggle" :class="{active: settings.showTheory}" @click="settings.showTheory = !settings.showTheory">{{ settings.showTheory ? 'ON' : 'OFF' }}</button>
                    </div>
                    <div class="row">
                        <span>‚è≥ Timer Limit</span>
                        <button class="btn-toggle" :class="{active: settings.timerEnabled}" @click="settings.timerEnabled = !settings.timerEnabled">{{ settings.timerEnabled ? 'ON' : 'OFF' }}</button>
                    </div>
                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:20px 0;">
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn btn-secondary" @click="exportData">Backup</button>
                        <label class="btn btn-secondary" style="cursor:pointer;">Import<input type="file" style="display:none" @change="importData" accept=".json"></label>
                    </div>
                    <div style="text-align:center; margin-top:20px;">
                        <button class="btn btn-secondary" style="color:var(--accent); border-color:var(--accent);" @click="resetData">Reset Save Data</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showAchievements" class="modal-overlay" @click.self="showAchievements = false">
            <div class="modal-box">
                <div class="modal-header">
                    <h2 class="modal-title">üèÜ Awards ({{ unlockedBadgeCount }}/{{ achievements.length }})</h2>
                    <button class="btn-icon" @click="showAchievements = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="badge-grid">
                        <div v-for="badge in achievements" :key="badge.id" class="badge-item" :class="{unlocked: badge.unlocked}">
                            <span class="badge-icon" style="font-size:1.5rem;">{{ badge.icon }}</span>
                            <div class="badge-name" style="font-size:0.6rem; margin-top:5px; color:#ccc;">{{ badge.name }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="app-footer">
        ¬©2025 <a href="https://note.com/jazzy_begin" style="color:inherit; text-decoration:none;">buro</a>
    </footer>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick, reactive } = Vue;

    // --- AUDIO SYSTEM (POWERED BY TONE.JS) ---
    class AudioEngine {
        constructor() {
            this.synth = null;
            this.reverb = null;
            this.enabled = true;
            this.isInitialized = false;
        }

        async init() {
            if (this.isInitialized) return;
            
            await Tone.start(); 

            this.synth = new Tone.PolySynth(Tone.Synth, {
                maxPolyphony: 6, 
                options: {
                    oscillator: { type: "triangle" }, 
                    envelope: {
                        attack: 0.02, decay: 0.3, sustain: 0.3, release: 1.2
                    }
                }
            });

            this.reverb = new Tone.Reverb({
                decay: 2.5, preDelay: 0.1, wet: 0.3
            }).toDestination();

            this.filter = new Tone.Filter(800, "lowpass").connect(this.reverb);
            this.synth.connect(this.filter);
            
            this.synth.volume.value = -20; 
            
            this.isInitialized = true;
            console.log("Tone.js Audio Engine Initialized");
        }

        play(freqs, type = 'sine', dur = 0.5, vol = 0.1) {
            if (!this.enabled) return;
            if (!this.isInitialized) {
                this.init().then(() => this.triggerSound(freqs, dur));
            } else {
                this.triggerSound(freqs, dur);
            }
        }

        triggerSound(freqs, dur) {
            if (!this.synth) return;
            this.synth.triggerAttackRelease(freqs, dur);
        }

        sfxSuccess() { 
            if(!this.enabled) return;
            this.play([523.25, 659.25, 783.99, 1046.50], null, 0.4); 
        }

        sfxCombo(count) { 
            if(!this.enabled) return;
            let base = 261.63 * (1 + (Math.min(count, 10) * 0.1)); 
            this.play([base, base * 1.5], null, 0.2);
        }

        sfxFail() { 
            if(!this.enabled) return;
            if (this.isInitialized) {
                const noise = new Tone.MembraneSynth().toDestination();
                noise.triggerAttackRelease("C1", "8n");
                noise.volume.value = -20;
            }
        }

        sfxRankUp() { 
            if(!this.enabled) return;
            const now = Tone.now();
            this.synth.triggerAttackRelease(["C4", "E4", "G4"], 0.2, now);
            this.synth.triggerAttackRelease(["C4", "E4", "G4"], 0.2, now + 0.2);
            this.synth.triggerAttackRelease(["C4", "F4", "A4", "C5"], 2.0, now + 0.4);
        }
    }

    const audio = new AudioEngine();

    const DEGREE_EXPLANATIONS = {
        0: 'Root: „Ç≥„Éº„Éâ„ÅÆÂúüÂè∞„Å®„Å™„ÇãÈü≥„ÄÇ', 3: 'Minor 3rd: „Éû„Ç§„Éä„Éº„Ç≥„Éº„Éâ„ÇíÊ±∫ÂÆö„Å•„Åë„ÇãÊÇ≤„Åó„ÅÑÈüø„Åç„ÄÇ', 4: 'Major 3rd: „É°„Ç∏„É£„Éº„Ç≥„Éº„Éâ„ÇíÊ±∫ÂÆö„Å•„Åë„ÇãÊòé„Çã„ÅÑÈüø„Åç„ÄÇ',
        5: 'Perfect 4th: „Çµ„Çπ„Ç≥„Éº„Éâ„Å™„Å©„Åß‰Ωø„Çè„Çå„ÇãÁ∑äÂºµÊÑü„ÅÆ„ÅÇ„ÇãÈü≥„ÄÇ', 6: 'Flat 5th: „Éñ„É´„Éº„Éé„Éº„Éà„ÄÅ„Åæ„Åü„ÅØ„Éá„Ç£„Éü„Éã„ÉÉ„Ç∑„É•„ÅÆ‰∏çÂÆâÂÆö„Å™Èü≥„ÄÇ',
        7: 'Perfect 5th: „Ç≥„Éº„Éâ„Å´ÂäõÂº∑„Åï„Å®ÂÆâÂÆö„Çí‰∏é„Åà„ÇãÈü≥„ÄÇ', 10: 'Minor 7th: „Éâ„Éü„Éä„É≥„Éà„ÇÑ„Éû„Ç§„Éä„Éº„Å´ÂøÖÈ†à„ÅÆ„Éñ„É´„Éº„Ç∏„Éº„Å™Èü≥„ÄÇ', 11: 'Major 7th: ÈÉΩ‰ºöÁöÑ„ÅßÊ¥óÁ∑¥„Åï„Çå„Åü„Ç∏„É£„Ç∫„ÅÆÈüø„Åç„ÄÇ'
    };

    const ACHIEVEMENT_LIST = [
        { id: 'first_win', name: 'Debut', icon: 'üé´', check: (s) => s.totalScore > 0 },
        { id: 'score_10k', name: 'Local Hero', icon: 'üé©', check: (s) => s.totalScore >= 10000 },
        { id: 'combo_10', name: 'Flow State', icon: 'üåä', check: (s, session) => session.maxCombo >= 10 },
        { id: 'combo_30', name: 'Virtuoso', icon: 'üé∑', check: (s, session) => session.maxCombo >= 30 },
        { id: 'master_c', name: 'C-Shape Master', icon: 'C', check: (s) => (s.shape['C']?.correct || 0) >= 50 },
        { id: 'song_master', name: 'Real Book Scholar', icon: 'üìñ', check: (s) => (s.completedSongs?.length || 0) >= 10 },
        { id: 'streak_7', name: 'Weekly Warrior', icon: 'üî•', check: (s) => s.loginStreak >= 7 },
        { id: 'perfect_session', name: 'Flawless', icon: 'üíé', check: (s, session) => session.perfect10 === true },
        { id: 'heatmap_pro', name: 'Fretboard Master', icon: 'üó∫Ô∏è', check: (s) => {
             if (!s.heatmap) return false;
             let hits=0, total=0;
             s.heatmap.forEach(r => r.forEach(c => { hits+=c.hits; total+=(c.hits+c.miss); }));
             return total > 50 && (hits/total) > 0.8;
        }}
    ];

    const RANKS = [
        { name: "Busker", limit: 2000 }, { name: "Club Cat", limit: 10000 }, { name: "Session Pro", limit: 50000 },
        { name: "Maestro", limit: 200000 }, { name: "Legend", limit: 999999999 }
    ];

    const parseChordString = (str) => {
        const match = str.match(/^([A-G][#b]?)(.*)$/);
        if (!match) return { root:'C', type:'maj7' };
        const root = match[1]; let type = match[2] || 'maj7';
        if (type.includes('maj') || type === '') type = 'maj7';
        else if (type.includes('m7b5') || type.includes('√∏')) type = 'm7b5';
        else if (type.includes('m') || type.includes('-')) type = 'm7';
        else if (type.includes('7') || type.includes('9') || type.includes('13')) type = '7';
        else type = 'maj7';
        return { root, type };
    };

    const RAW_SONG_DATA = [
        { t: "Autumn Leaves", k: "Gm", c: "Cm7 F7 Bbmaj7 Ebmaj7 Am7b5 D7 Gm7 Gm7 Cm7 F7 Bbmaj7 Ebmaj7 Am7b5 D7 Gm7 Gm7 Am7b5 D7 Gm7 Gm7 Cm7 F7 Bbmaj7 Ebmaj7 Am7b5 D7 Gm7 Gb7 Fm7 E7 Am7b5 D7 Gm7" },
        { t: "Fly Me To The Moon", k: "C", c: "Am7 Dm7 G7 Cmaj7 Fmaj7 Bm7b5 E7 Am7 A7 Dm7 G7 Cmaj7 Cmaj7 Bm7b5 E7 Am7 A7 Dm7 G7 Em7 A7 Dm7 G7 Cmaj7 Bm7b5 E7" },
        { t: "All The Things You Are", k: "Ab", c: "Fm7 Bbm7 Eb7 Abmaj7 Dbmaj7 Dm7 G7 Cmaj7 Cm7 Fm7 Bb7 Ebmaj7 Abmaj7 Am7 D7 Gmaj7 Am7 D7 Gmaj7 Gbm7 B7 Emaj7 C7 Fm7 Bbm7 Eb7 Abmaj7 Dbmaj7 Dbm7 Cm7 Bdim7 Bbm7 Eb7 Abmaj7" },
        { t: "Blue Bossa", k: "Cm", c: "Cm7 Cm7 Fm7 Fm7 Dm7b5 G7 Cm7 Cm7 Ebm7 Ab7 Dbmaj7 Dbmaj7 Dm7b5 G7 Cm7 Dm7b5 G7" },
        { t: "Take The A Train", k: "C", c: "Cmaj7 Cmaj7 D7b5 D7b5 Dm7 G7 Cmaj7 Dm7 G7 Cmaj7 Cmaj7 D7b5 D7b5 Dm7 G7 Cmaj7 Gm7 C7 Fmaj7 Fmaj7 Fmaj7 Fmaj7 D7b5 D7b5 Dm7 G7 Cmaj7 Cmaj7 D7b5 D7b5 Dm7 G7 Cmaj7 Cmaj7" },
        { t: "Satin Doll", k: "C", c: "Dm7 G7 Dm7 G7 Em7 A7 Em7 A7 Dm7 G7 Dm7 G7 Cmaj7 Dm7 G7 Dm7 G7 Dm7 G7 Em7 A7 Em7 A7 Dm7 G7 Dm7 G7 Cmaj7 C7 Fmaj7 Fmaj7 Em7 A7 Am7 D7 Dm7 G7 Dm7 G7 Dm7 G7 Em7 A7 Em7 A7 Dm7 G7 Dm7 G7 Cmaj7" },
        { t: "Girl From Ipanema", k: "F", c: "Fmaj7 Fmaj7 G7 G7 Gm7 Gb7 Fmaj7 Gb7 Fmaj7 Fmaj7 G7 G7 Gm7 Gb7 Fmaj7 Fmaj7 Gbmaj7 Gbmaj7 B7 B7 Gbm7 Gbm7 D7 D7 Gm7 Gm7 Eb7 Eb7 Am7 D7 Gm7 C7 Fmaj7 Fmaj7 G7 G7 Gm7 Gb7 Fmaj7" },
        { t: "So What", k: "Dm", c: "Dm7 Dm7 Dm7 Dm7 Dm7 Dm7 Dm7 Dm7 Ebm7 Ebm7 Ebm7 Ebm7 Dm7 Dm7 Dm7 Dm7" },
        { t: "Summertime", k: "Dm", c: "Dm7 Dm7 Dm7 Dm7 Gm7 Gm7 Dm7 Dm7 E7 Am7 Dm7 Dm7" },
        { t: "Stella By Starlight", k: "Bb", c: "Em7b5 A7 Cm7 F7 Fm7 Bb7 Ebmaj7 Ab7 Bbmaj7 Em7b5 A7 Dm7 Bbm7 Eb7 Fmaj7 Em7b5 A7 Am7b5 D7 G7 Cm7 Ab7 Bbmaj7 Em7b5 A7 Cm7 F7 Bbmaj7" },
        { t: "There Will Never Be Another You", k: "Eb", c: "Ebmaj7 Ebmaj7 Dm7b5 G7 Cm7 Cm7 Bbm7 Eb7 Abmaj7 Abmaj7 Db7 Db7 Ebmaj7 Cm7 Fm7 Bb7 Ebmaj7 Dm7b5 G7 Cm7 Cm7 Bbm7 Eb7 Abmaj7 Abmaj7 Db7 Db7 Ebmaj7 Cm7 Fm7 Bb7 Ebmaj7 Ab7 Gm7 C7 Fm7 Bb7 Ebmaj7" },
        { t: "On Green Dolphin Street", k: "Eb", c: "Ebmaj7 Ebmaj7 Ebmaj7 Ebmaj7 Gbmaj7 Gbmaj7 Gbmaj7 Gbmaj7 Ebmaj7 Ebmaj7 Ebmaj7 Ebmaj7 Gbmaj7 Gbmaj7 Gbmaj7 Gbmaj7 Fm7 Bb7 Ebmaj7 Gm7 C7 Fm7 Bb7 Ebmaj7" },
        { t: "Confirmation", k: "F", c: "Fmaj7 Em7b5 A7 Dm7 Cm7 F7 Bbmaj7 Am7 D7 G7 Gm7 C7 Fmaj7 Em7b5 A7 Dm7 Cm7 F7 Bbmaj7 Am7 D7 Gm7 C7 Fmaj7 Cm7 F7 Bbmaj7 Bbmaj7 A7 A7 Dm7 D7 G7 G7 Gm7 C7 Fmaj7 Em7b5 A7 Dm7 Cm7 F7 Bbmaj7 Am7 D7 Gm7 C7 Fmaj7" },
        { t: "Giant Steps", k: "Eb", c: "Bmaj7 D7 Gmaj7 Bb7 Ebmaj7 Am7 D7 Gmaj7 Bb7 Ebmaj7 Gb7 Bmaj7 Fm7 Bb7 Ebmaj7 Am7 D7 Gmaj7 Dbm7 Gb7 Bmaj7 Fm7 Bb7 Ebmaj7 Dbm7 Gb7" },
        { t: "Oleo", k: "Bb", c: "Bbmaj7 Gm7 Cm7 F7 Bbmaj7 Gm7 Cm7 F7 Em7 A7 Dm7 G7 Cm7 F7 Bbmaj7 Bbmaj7 Gm7 Cm7 F7 Bbmaj7 Gm7 Cm7 F7 Em7 A7 Dm7 G7 Cm7 F7 Bbmaj7 D7 G7 C7 F7 Bbmaj7 Gm7 Cm7 F7 Bbmaj7 Gm7 Cm7 F7 Em7 A7 Dm7 G7 Cm7 F7 Bbmaj7" },
        { t: "Solar", k: "Cm", c: "Cm7 Cm7 Gm7 C7 Fmaj7 Fmaj7 Fm7 Bb7 Ebmaj7 Ebmaj7 Ebm7 Ab7 Dbmaj7 Dm7b5 G7 Cm7" },
        { t: "Just Friends", k: "G", c: "Cmaj7 Cmaj7 Cm7 F7 Gmaj7 Gmaj7 Bbm7 Eb7 Am7 D7 Am7 D7 Gmaj7 Em7 Am7 D7 Cm7 F7 Gmaj7 E7 Am7 D7 Gmaj7" },
        { t: "Days of Wine and Roses", k: "F", c: "Fmaj7 Eb7 D7 D7 Gm7 Bbm7 Fmaj7 Em7 A7 Dm7 G7 Gm7 C7 Am7 D7 Gm7 C7 Fmaj7 Eb7 D7 D7 Gm7 Bbm7 Fmaj7 Em7b5 A7 Dm7 Gm7 Am7b5 D7 Gm7 C7 Fmaj7" },
        { t: "Wave", k: "D", c: "Dmaj7 Bbm7 A7 Dmaj7 G7 G7 Gmaj7 Gm7 Gb7 B7 E7 Bb7 A7 Dm7 G7 Dmaj7 Dmaj7 Gm7 C7 Fmaj7 Fmaj7 Fm7 Bb7 Ebmaj7 A7 Dm7 G7 Gm7 C7 Fmaj7 Fm7 Bb7 Em7 A7 Dmaj7 Bbm7 A7 Dmaj7 G7 G7 Gmaj7 Gm7 Gb7 B7 E7 Bb7 A7 Dmaj7" },
        { t: "Body and Soul", k: "Db", c: "Ebm7 Bb7 Ebm7 D7 Dbmaj7 Gb7 Fm7 E7 Ebm7 Bb7 Ebm7 D7 Dbmaj7 Ebm7 Ab7 Dbmaj7 Dmaj7 Em7 A7 Dmaj7 Dm7 G7 Cmaj7 Eb7 Ab7 Dbmaj7" },
        { t: "Cherokee", k: "Bb", c: "Bbmaj7 Fm7 Bb7 Ebmaj7 Ab7 Bbmaj7 C7 Cm7 F7 Bbmaj7 Fm7 Bb7 Ebmaj7 Ab7 Bbmaj7 C7 Cm7 F7 Bbmaj7 Dbm7 Gb7 Bmaj7 Bmaj7 Bm7 E7 Amaj7 Amaj7 Am7 D7 Gmaj7 Gmaj7 Gm7 C7 Cm7 F7 Bbmaj7 Fm7 Bb7 Ebmaj7 Ab7 Bbmaj7 C7 Cm7 F7 Bbmaj7" },
        { t: "Donna Lee", k: "Ab", c: "Abmaj7 F7 Bb7 Bb7 Bbm7 Eb7 Abmaj7 Eb7 Abmaj7 F7 Bb7 Bb7 Bb7 Bb7 Bbm7 Eb7 Abmaj7 F7 Bb7 Bb7 C7 C7 Fm7 C7 Fm7 C7b9 Fm7 Abdim7 Abmaj7 F7 Bbm7 Eb7 Abmaj7" },
        { t: "Four", k: "Eb", c: "Ebmaj7 Ebm7 Ab7 Fm7 Bb7 Gm7b5 C7 Fm7 Abm7 Db7 Ebmaj7 Gbdim7 Fm7 Bb7 Ebmaj7 Ebm7 Ab7 Fm7 Bb7 Gm7b5 C7 Fm7 Abm7 Db7 Ebmaj7 Fm7 Bb7 Ebmaj7" },
        { t: "I'll Remember April", k: "G", c: "Gmaj7 Gmaj7 Gm7 Gm7 Am7 D7 Bm7 E7 Am7 D7 Am7 D7 Gmaj7 Gmaj7 Bm7b5 E7 Am7 Am7 Cm7 F7 Gmaj7 Gmaj7 Bm7b5 E7 Am7 D7 Gmaj7" },
        { t: "It Could Happen To You", k: "Eb", c: "Ebmaj7 Gm7b5 C7 Fm7 Am7b5 D7 Ebmaj7 Abmaj7 Gm7 C7 Fm7 Bb7 Ebmaj7 Gm7b5 C7 Fm7 Am7b5 D7 Ebmaj7 Abmaj7 Gm7 C7 Fm7 Bb7 Abmaj7 Gm7 Fm7 Bb7 Ebmaj7" },
        { t: "Softly, As In A Morning Sunrise", k: "Cm", c: "Cm7 Dm7b5 G7 Cm7 Dm7b5 G7 Cm7 Dm7b5 G7 Cm7 Cm7 Ebmaj7 Fm7 Bb7 Ebmaj7 Dm7b5 G7 Cm7 Dm7b5 G7 Cm7 Dm7b5 G7 Cm7 Dm7b5 G7" },
        { t: "Song For My Father", k: "Fm", c: "Fm7 Fm7 Eb7 Db7 C7 C7 Fm7 Fm7 Eb7 Db7 C7 C7 Fm7 Eb7 Db7 C7 Fm7" },
        { t: "St. Thomas", k: "C", c: "Cmaj7 Cmaj7 Em7b5 A7 Dm7 G7 Cmaj7 Cmaj7 Em7b5 A7 Dm7 G7 Cmaj7 Cmaj7 Dm7 G7 Cmaj7 Dm7 G7 Cmaj7 Em7b5 A7 Dm7 G7 Cmaj7" },
        { t: "Yardbird Suite", k: "C", c: "Cmaj7 Fm7 Bb7 Cmaj7 Bm7b5 E7 Am7 D7 Dm7 G7 Cmaj7 Fm7 Bb7 Cmaj7 Bm7b5 E7 Am7 D7 Dm7 G7 Em7 A7 Dm7 G7 Em7 A7 Dm7 G7 Cmaj7 Fm7 Bb7 Cmaj7 Bm7b5 E7 Am7 D7 Dm7 G7 Cmaj7" },
        { t: "Tune Up", k: "D", c: "Em7 A7 Dmaj7 Dmaj7 Dm7 G7 Cmaj7 Cmaj7 Cm7 F7 Bbmaj7 Bbmaj7 Em7 A7 Bbmaj7 A7" }
    ];

    const SONG_BOOK = RAW_SONG_DATA.map(s => ({
        id: s.t.toLowerCase().replace(/\s/g, '_'),
        title: s.t,
        key: s.k,
        chords: s.c.split(' ').map(str => parseChordString(str))
    })).sort((a,b) => a.title.localeCompare(b.title));

    const getFeedbackMessage = (combo) => {
        const messages = {
            1: ['Nice!', 'Good!', 'Yeah!', 'Sweet!'],
            5: ['On Fire! üî•', 'Groovy!', 'Smooth!', 'Cookin\'!'],
            10: ['Incredible!', 'Legendary!', 'Phenomenal!', 'Master Class! üé∑'],
            20: ['UNSTOPPABLE! ‚ö°', 'JAZZ GOD! üëë', 'TRANSCENDENT! ‚ú®']
        };
        let tier = 1;
        if (combo >= 20) tier = 20;
        else if (combo >= 10) tier = 10;
        else if (combo >= 5) tier = 5;
        const pool = messages[tier];
        return pool[Math.floor(Math.random() * pool.length)];
    };

    createApp({
        setup() {
            const currentView = ref('title');
            const showSettings = ref(false);
            const showAnalysis = ref(false);
            const showAchievements = ref(false);
            const showHelp = ref(false); 
            const showRankUp = ref(false);
            const showSongSelect = ref(false);
            const analysisTab = ref('stats');
            const searchQuery = ref('');
            
            const difficulty = ref('normal');
            const selectedKey = ref('ALL');
            const selectedShape = ref('ALL');
            const gameMode = ref('normal'); 
            
            const stats = reactive({
                totalScore: 0,
                mistakeLog: [],
                playHistory: [],
                degree: {}, shape: {}, key: {},
                heatmap: [], 
                completedSongs: [],
                loginStreak: 0, lastLogin: null
            });
            const achievements = ref(ACHIEVEMENT_LIST.map(a => ({...a, unlocked: false})));
            const settings = reactive({ sound: true, showTheory: true, timerEnabled: true });
            
            const dailyMission = ref(null);
            
            const sessionScore = ref(0);
            const combo = ref(0);
            const maxCombo = ref(0);
            const perfect10 = ref(false);
            const currentQuestion = ref({});
            const fretboardDots = ref([]);
            const displayRange = ref({min:0, max:12});
            const feedback = ref({msg:'', sub:'', color:''});
            const timerWidth = ref(100);
            const isProcessing = ref(false);
            
            // --- FIX FOR BUG: Game continuing after exit ---
            let timerInterval = null;
            let nextQuestionTimeout = null; 
            // -----------------------------------------------
            
            const revealed = ref(false);
            const ingameRankUp = ref(false);
            const lastRankIndex = ref(0);
            
            const currentSong = ref(null);
            const songIndex = ref(0);

            const comboMultiplier = computed(() => Math.min(combo.value, 50) || 1);
            
            const currentTotalScore = computed(() => stats.totalScore + sessionScore.value);

            const currentRankInfo = computed(() => {
                let current = RANKS[0];
                let next = RANKS[1];
                let idx = 0;
                // Use currentTotalScore instead of just stats.totalScore
                for(let i=0; i<RANKS.length-1; i++) {
                    if (currentTotalScore.value >= RANKS[i].limit) {
                        current = RANKS[i+1];
                        next = RANKS[i+2] || { limit: currentTotalScore.value * 1.5 };
                        idx = i+1;
                    } else {
                        current = RANKS[i];
                        next = RANKS[i+1];
                        idx = i;
                        break;
                    }
                }
                const prevLimit = RANKS.indexOf(current) > 0 ? RANKS[RANKS.indexOf(current)-1].limit : 0;
                const progress = Math.min(100, Math.max(0, ((currentTotalScore.value - prevLimit) / (current.limit - prevLimit)) * 100));
                return { name: current.name, progress, nextReq: current.limit, index: idx };
            });

            const statsOverview = computed(() => {
                const totalAttempts = Object.values(stats.degree).reduce((a,b) => a + (b.attempts||0), 0);
                const totalCorrect = Object.values(stats.degree).reduce((a,b) => a + (b.correct||0), 0);
                const avgAccuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
                const totalSessions = stats.playHistory.length;
                const totalSongs = stats.completedSongs ? stats.completedSongs.length : 0;
                return { totalAttempts, avgAccuracy, totalSessions, totalSongs };
            });

            const filteredSongs = computed(() => {
                if (!searchQuery.value) return SONG_BOOK;
                const q = searchQuery.value.toLowerCase();
                return SONG_BOOK.filter(s => s.title.toLowerCase().includes(q));
            });

            const nextChordName = computed(() => {
                if (gameMode.value !== 'song' || !currentSong.value) return null;
                const nextIdx = (songIndex.value + 1) % currentSong.value.chords.length;
                const c = currentSong.value.chords[nextIdx];
                return c.root + c.type;
            });

            const unlockedBadgeCount = computed(() => achievements.value.filter(a => a.unlocked).length);
            const timerColor = computed(() => timerWidth.value < 30 ? "#ef4444" : "#c5a059");
            
            const srsDueCount = computed(() => {
                const now = Date.now();
                return stats.mistakeLog.filter(m => !m.nextReview || m.nextReview <= now).length;
            });

            const theoryTip = computed(() => DEGREE_EXPLANATIONS[currentQuestion.value.targetInterval]);
            const playHistory = computed(() => stats.playHistory);
            const keysList = ['C', 'G', 'D', 'A', 'E', 'B', 'F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb'];

            // --- LIFECYCLE & DATA MGT ---
            const STORAGE_KEY = 'caged_jazz_v2'; 
            let charts = {};
            
            const loadData = () => {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    const d = JSON.parse(raw);
                    stats.totalScore = d.totalScore || 0;
                    stats.mistakeLog = d.mistakeLog || [];
                    stats.playHistory = d.playHistory || [];
                    stats.degree = d.degree || {};
                    stats.shape = d.shape || {};
                    stats.key = d.key || {};
                    stats.completedSongs = d.completedSongs || [];
                    
                    if (d.heatmap && Array.isArray(d.heatmap) && Array.isArray(d.heatmap[0])) {
                         stats.heatmap = d.heatmap; 
                    } else {
                         stats.heatmap = Array(6).fill(null).map(() => Array(5).fill(null).map(() => ({hits:0, miss:0})));
                    }
                    
                    stats.loginStreak = d.loginStreak || 1;
                    stats.lastLogin = d.lastLogin || Date.now();
                    checkLoginStreak();

                    settings.sound = d.settings?.sound ?? true;
                    settings.showTheory = d.settings?.showTheory ?? true;
                    settings.timerEnabled = d.settings?.timerEnabled ?? true;
                    if (d.unlockedIds) {
                        d.unlockedIds.forEach(id => {
                            const b = achievements.value.find(a => a.id === id);
                            if(b) b.unlocked = true;
                        });
                    }
                    if (d.daily) checkDailyReset(d.daily); else generateDailyMission();
                } else {
                    generateDailyMission();
                    stats.heatmap = Array(6).fill(null).map(() => Array(5).fill(null).map(() => ({hits:0, miss:0})));
                    stats.lastLogin = Date.now();
                    stats.loginStreak = 1;
                }
                audio.enabled = settings.sound;
            };

            const checkLoginStreak = () => {
                const now = new Date();
                const last = new Date(stats.lastLogin);
                const isSameDay = now.toDateString() === last.toDateString();
                if (!isSameDay) {
                    const diffTime = Math.abs(now - last);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if (diffDays <= 2) stats.loginStreak++;
                    else stats.loginStreak = 1; 
                    stats.lastLogin = Date.now();
                    saveData();
                }
            };

            const saveData = () => {
                const data = {
                    totalScore: stats.totalScore,
                    mistakeLog: stats.mistakeLog,
                    playHistory: stats.playHistory,
                    degree: stats.degree, shape: stats.shape, key: stats.key,
                    heatmap: stats.heatmap, completedSongs: stats.completedSongs,
                    loginStreak: stats.loginStreak, lastLogin: stats.lastLogin,
                    settings: settings,
                    unlockedIds: achievements.value.filter(a=>a.unlocked).map(a=>a.id),
                    daily: dailyMission.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            const generateDailyMission = () => {
                const goals = [
                    { type: 'score', val: 3000, desc: 'Êú¨Êó•„ÅÆ„Çπ„Ç≥„Ç¢ 3,000 pts „ÇíÈÅîÊàê„Åõ„Çà' },
                    { type: 'combo', val: 20, desc: '20„Ç≥„É≥„Éú„ÇíÈÅîÊàê„Åõ„Çà' },
                    { type: 'shape', target: 'A', val: 10, desc: 'A„Éï„Ç©„Éº„É†„Åß10ÂõûÊ≠£Ëß£„Åõ„Çà' }
                ];
                const seed = new Date().getDate() % goals.length;
                const g = goals[seed];
                dailyMission.value = { ...g, progress: 0, goal: g.val, date: new Date().toLocaleDateString() };
            };

            const checkDailyReset = (savedDaily) => {
                if (savedDaily.date !== new Date().toLocaleDateString()) generateDailyMission();
                else dailyMission.value = savedDaily;
            };

            const updateDailyProgress = (type, val, target) => {
                if (!dailyMission.value || dailyMission.value.progress >= dailyMission.value.goal) return;
                const dm = dailyMission.value;
                if (dm.type === type) {
                    if (type === 'score') dm.progress += val;
                    if (type === 'combo' && val > dm.progress) dm.progress = val;
                    if (type === 'shape' && target === dm.target) dm.progress++;
                }
                if (dm.progress > dm.goal) dm.progress = dm.goal;
            };

            const checkAchievements = () => {
                achievements.value.forEach(badge => {
                    if (!badge.unlocked && badge.check(stats, { maxCombo: maxCombo.value, perfect10: perfect10.value })) {
                        badge.unlocked = true;
                        audio.sfxCombo(10); 
                    }
                });
            };

            const notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const tuning = [4, 11, 7, 2, 9, 4];
            const shapeConfig = { 'C': { rootStrIdx: 4, offset: -3, span: 4 }, 'A': { rootStrIdx: 4, offset: 0, span: 4 }, 'G': { rootStrIdx: 5, offset: -3, span: 4 }, 'E': { rootStrIdx: 5, offset: 0, span: 4 }, 'D': { rootStrIdx: 3, offset: 0, span: 4 } };
            const diatonic = [{ r: 'Imaj7', i:[0,4,7,11] }, { r: 'iim7', i:[0,3,7,10] }, { r: 'iiim7', i:[0,3,7,10] }, { r: 'IVmaj7', i:[0,4,7,11] }, { r: 'V7', i:[0,4,7,10] }, { r: 'vim7', i:[0,3,7,10] }, { r: 'viim7b5', i:[0,3,6,10] }];

            const startGame = (mode, songData = null) => {
                audio.init();
                gameMode.value = mode;
                sessionScore.value = 0;
                combo.value = 0;
                maxCombo.value = 0;
                perfect10.value = false;
                lastRankIndex.value = currentRankInfo.value.index; // Track starting rank index
                
                if (mode === 'song' && songData) {
                    currentSong.value = songData;
                    songIndex.value = 0;
                    showSongSelect.value = false;
                }
                currentView.value = 'game';
                nextQuestion();
            };
            const startSongMode = (song) => startGame('song', song);

            const nextQuestion = () => {
                // BUG FIX: Prevent next question if game has ended
                if (currentView.value !== 'game') return;

                isProcessing.value = false;
                revealed.value = false; 
                feedback.value = { msg: '' };
                let q = {};
                
                if (gameMode.value === 'srs') {
                    const now = Date.now();
                    const due = stats.mistakeLog.filter(m => !m.nextReview || m.nextReview <= now);
                    if (due.length === 0) { endSession(); return; }
                    q = { ...due[Math.floor(Math.random() * due.length)] };
                } 
                else if (gameMode.value === 'song') {
                    const chordData = currentSong.value.chords[songIndex.value];
                    q.chordRootVal = notes.indexOf(chordData.root);
                    if (chordData.type === 'maj7') q.intervals = [0,4,7,11];
                    else if (chordData.type === 'm7') q.intervals = [0,3,7,10];
                    else if (chordData.type === '7') q.intervals = [0,4,7,10];
                    else if (chordData.type === 'm7b5') q.intervals = [0,3,6,10];
                    else q.intervals = [0,4,7,11];
                    q.chordName = chordData.root + chordData.type;
                    q.keyInfo = `${currentSong.value.title} (${songIndex.value + 1}/${currentSong.value.chords.length})`;
                    let shape = selectedShape.value;
                    if (shape === 'ALL') shape = ['C','A','G','E','D'][Math.floor(Math.random()*5)];
                    q.shape = shape;
                    const targets = q.intervals.filter(i => i !== 0); 
                    q.targetInterval = targets[Math.floor(Math.random() * targets.length)];
                    q.targetDegreeName = {3:'b3',4:'3',6:'b5',7:'5',10:'b7',11:'7'}[q.targetInterval];
                    
                    const conf = shapeConfig[shape];
                    let rootPos = (q.chordRootVal - tuning[conf.rootStrIdx] + 12) % 12;
                    if (rootPos + conf.offset < 0) {
                        rootPos += 12;
                    }
                    q.minF = rootPos + conf.offset;
                    q.maxF = q.minF + 5;
                } else {
                    let keyRoot;
                    let keyName = selectedKey.value;
                    if (keyName === 'ALL') { keyRoot = Math.floor(Math.random()*12); keyName = notes[keyRoot]; } 
                    else { keyRoot = notes.indexOf(keyName); }
                    if (selectedKey.value !== 'ALL') {
                        const offsets = [0,2,4,5,7,9,11];
                        const idx = Math.floor(Math.random()*7);
                        q.chordRootVal = (keyRoot + offsets[idx]) % 12;
                        q.intervals = diatonic[idx].i;
                        q.chordName = notes[q.chordRootVal] + (q.intervals.includes(3)?'m':'') + (q.intervals.includes(11)?'maj7':'7');
                        if (q.intervals.includes(6)) q.chordName = notes[q.chordRootVal] + 'm7b5';
                        q.keyInfo = keyName;
                    } else {
                        q.keyInfo = 'Random';
                        q.chordRootVal = Math.floor(Math.random()*12);
                        const type = Math.random();
                        if(type<0.33) { q.intervals=[0,4,7,11]; q.chordName=notes[q.chordRootVal]+'maj7'; }
                        else if(type<0.66) { q.intervals=[0,3,7,10]; q.chordName=notes[q.chordRootVal]+'m7'; }
                        else { q.intervals=[0,4,7,10]; q.chordName=notes[q.chordRootVal]+'7'; }
                    }
                    let shape = selectedShape.value;
                    if (shape === 'ALL') shape = ['C','A','G','E','D'][Math.floor(Math.random()*5)];
                    q.shape = shape;
                    
                    const targets = q.intervals.filter(i => i !== 0); 
                    q.targetInterval = targets[Math.floor(Math.random() * targets.length)];
                    q.targetDegreeName = {3:'b3',4:'3',6:'b5',7:'5',10:'b7',11:'7'}[q.targetInterval];
                    
                    const conf = shapeConfig[shape];
                    let rootPos = (q.chordRootVal - tuning[conf.rootStrIdx] + 12) % 12;
                    if (rootPos + conf.offset < 0) {
                        rootPos += 12;
                    }
                    q.minF = rootPos + conf.offset;
                    q.maxF = q.minF + 5;
                }

                currentQuestion.value = q;
                displayRange.value = { min: q.minF, max: q.maxF };
                fretboardDots.value = [];
                for (let s=0; s<6; s++) {
                    for (let f=q.minF; f<=q.maxF; f++) {
                        const note = (tuning[s] + f) % 12;
                        const interval = (note - q.chordRootVal + 12) % 12;
                        if (q.intervals.includes(interval)) {
                            // GUIDE: Only for EASY mode + Root note
                            let isRootGuide = (difficulty.value === 'easy' && interval === 0);
                            
                            fretboardDots.value.push({
                                string: s, fret: f, interval: interval,
                                degree: {0:'R',3:'b3',4:'3',5:'4',6:'b5',7:'5',10:'b7',11:'7'}[interval],
                                isTarget: interval === q.targetInterval, isRoot: interval === 0, r: 12, 
                                fill: isRootGuide ? '#444' : '#333', stroke: isRootGuide ? 'var(--primary)' : 'none',
                                textFill: '#fff', showLabel: isRootGuide
                            });
                        }
                    }
                }

                clearInterval(timerInterval);
                if (settings.timerEnabled && difficulty.value !== 'hard' && difficulty.value !== 'easy' && gameMode.value !== 'srs') {
                    // Normal timer
                    const timeLimit = 8;
                    let remain = timeLimit;
                    timerWidth.value = 100;
                    timerInterval = setInterval(() => {
                        remain -= 0.05;
                        timerWidth.value = (remain / timeLimit) * 100;
                        if (remain <= 0) handleShot(null, true);
                    }, 50);
                } else if (settings.timerEnabled && difficulty.value === 'hard') {
                    const timeLimit = 4;
                    let remain = timeLimit;
                    timerWidth.value = 100;
                    timerInterval = setInterval(() => {
                        remain -= 0.05;
                        timerWidth.value = (remain / timeLimit) * 100;
                        if (remain <= 0) handleShot(null, true);
                    }, 50);
                }
                 else { timerWidth.value = 100; }
            };

            const handleShot = (dot, timeUp) => {
                if (isProcessing.value) return;
                clearInterval(timerInterval);
                isProcessing.value = true;
                revealed.value = true; 
                const q = currentQuestion.value;
                const isCorrect = !timeUp && dot && dot.isTarget;

                const updateStat = (cat, key, correct) => {
                    if (!stats[cat][key]) stats[cat][key] = { attempts:0, correct:0 };
                    stats[cat][key].attempts++;
                    if (correct) stats[cat][key].correct++;
                };
                updateStat('degree', q.targetInterval, isCorrect);
                updateStat('shape', q.shape, isCorrect);
                if (q.keyInfo !== 'Random') updateStat('key', q.keyInfo, isCorrect);

                if (dot) {
                    const seg = Math.min(4, Math.floor(dot.fret / 3));
                    const sIdx = dot.string;
                    if(!stats.heatmap[sIdx]) stats.heatmap[sIdx] = [];
                    if(!stats.heatmap[sIdx][seg]) stats.heatmap[sIdx][seg] = {hits:0, miss:0};
                    if (isCorrect) stats.heatmap[sIdx][seg].hits++; else stats.heatmap[sIdx][seg].miss++;
                } else if (timeUp) {
                    const target = fretboardDots.value.find(d => d.isTarget);
                    if (target) {
                        const seg = Math.min(4, Math.floor(target.fret / 3));
                        const sIdx = target.string;
                        stats.heatmap[sIdx][seg].miss++;
                    }
                }

                if (gameMode.value === 'srs') {
                    const idx = stats.mistakeLog.findIndex(m => m.chordName === q.chordName && m.targetInterval === q.targetInterval);
                    if (idx > -1) {
                        const item = stats.mistakeLog[idx];
                        if (isCorrect) {
                            item.level = (item.level || 0) + 1;
                            const intervals = [4*60*60*1000, 12*60*60*1000, 24*60*60*1000, 3*24*60*60*1000, 7*24*60*60*1000];
                            if (item.level >= intervals.length) stats.mistakeLog.splice(idx, 1);
                            else item.nextReview = Date.now() + intervals[item.level];
                        } else {
                            item.level = 0;
                            item.nextReview = Date.now() + (10 * 60 * 1000); 
                        }
                    }
                } else if (!isCorrect) {
                     const exists = stats.mistakeLog.some(m => m.chordName === q.chordName && m.targetInterval === q.targetInterval);
                     if (!exists) {
                         stats.mistakeLog.push({ ...q, level: 0, nextReview: Date.now() + (10 * 60 * 1000) });
                     }
                }

                if (isCorrect) {
                    combo.value++;
                    if (combo.value > maxCombo.value) maxCombo.value = combo.value;
                    if (combo.value >= 10 && !perfect10.value) perfect10.value = true;
                    audio.sfxCombo(combo.value);
                    const pts = (difficulty.value === 'hard' ? 200 : 100) * comboMultiplier.value;
                    sessionScore.value += pts;
                    
                    // CHECK FOR IN-GAME RANK UP
                    if (currentRankInfo.value.index > lastRankIndex.value) {
                        lastRankIndex.value = currentRankInfo.value.index;
                        ingameRankUp.value = true;
                        audio.sfxRankUp();
                        setTimeout(() => ingameRankUp.value = false, 2500);
                    }

                    feedback.value = { msg: getFeedbackMessage(combo.value), sub: `+${pts}`, color: '#c5a059' };
                    if(dot) { dot.fill = '#c5a059'; dot.showLabel = true; }

                    updateDailyProgress('score', pts);
                    updateDailyProgress('combo', combo.value);
                    updateDailyProgress('shape', 1, q.shape);

                    if (gameMode.value === 'song') {
                        songIndex.value++;
                        if (songIndex.value >= currentSong.value.chords.length) {
                            songIndex.value = 0;
                            const bonus = currentSong.value.chords.length * 50;
                            sessionScore.value += bonus;
                            feedback.value = { msg: 'üéµ Song Complete!', sub: `Bonus +${bonus}`, color: '#84a98d' };
                            
                            if(!stats.completedSongs) stats.completedSongs = [];
                            if(!stats.completedSongs.includes(currentSong.value.id)) stats.completedSongs.push(currentSong.value.id);
                        }
                    }
                } else {
                    audio.sfxFail();
                    combo.value = 0;
                    feedback.value = { msg: timeUp ? 'Time Up' : 'Miss...', sub: timeUp ? '' : `Answer: ${dot?.degree}`, color: '#95353a' };
                    fretboardDots.value.forEach(d => {
                        if (d.isTarget) { d.fill = '#95353a'; d.showLabel = true; d.stroke = '#fff'; }
                        else if (dot && d === dot) { d.fill = '#555'; d.showLabel = true; }
                    });
                }
                saveData();
                
                // BUG FIX: Clear existing timeout before setting new one
                if (nextQuestionTimeout) clearTimeout(nextQuestionTimeout);
                nextQuestionTimeout = setTimeout(nextQuestion, isCorrect ? 800 : 2000);
            };

            const endSession = () => {
                clearInterval(timerInterval);
                if (nextQuestionTimeout) clearTimeout(nextQuestionTimeout); // BUG FIX: Cancel pending transition

                if (sessionScore.value > 0) {
                    const oldRank = currentRankInfo.value.name;
                    const sessionAccuracy = (() => {
                        const attempts = Object.values(stats.degree).reduce((a,b)=>a+(b.attempts||0),0);
                        const correct = Object.values(stats.degree).reduce((a,b)=>a+(b.correct||0),0);
                        return attempts > 0 ? Math.round((correct/attempts)*100) : 0;
                    })();

                    stats.playHistory.unshift({ date: new Date().toLocaleString(), score: sessionScore.value, accuracy: sessionAccuracy });
                    if (stats.playHistory.length > 20) stats.playHistory.pop();
                    stats.totalScore += sessionScore.value;
                    
                    checkAchievements(); 
                }
                saveData();
                currentView.value = 'title';
            };

            const getHeatmapColor = (stringIdx, segment) => {
                if (!stats.heatmap || !stats.heatmap[stringIdx] || !stats.heatmap[stringIdx][segment]) return '#222';
                const d = stats.heatmap[stringIdx][segment];
                const total = (d.hits || 0) + (d.miss || 0);
                if (total === 0) return '#222'; 
                const rate = d.hits / total;
                const errorRate = 1 - rate;
                if (errorRate > 0.6) return '#ef4444'; 
                if (errorRate > 0.3) return '#eab308'; 
                return '#22c55e'; 
            };

            const openAnalysis = () => {
                showAnalysis.value = true;
                nextTick(() => {
                    const ctxScore = document.getElementById('scoreChart');
                    if (ctxScore) {
                        if (charts.score) charts.score.destroy();
                        charts.score = new Chart(ctxScore, {
                            type: 'line',
                            data: {
                                labels: stats.playHistory.slice().reverse().map((_,i)=>i+1),
                                datasets: [{ label: 'Score', data: stats.playHistory.slice().reverse().map(p=>p.score), borderColor: '#c5a059', tension: 0.3 }]
                            },
                            options: { plugins: { legend: {display:false} }, scales: { x: {display:false}, y: {grid: {color:'#333'}} } }
                        });
                    }
                });
            };

            watch(analysisTab, (newVal) => {
                if (newVal === 'weakness') {
                    nextTick(() => {
                        const ctxDeg = document.getElementById('degreeChart');
                        const labels = ['R', 'b3', '3', '5', 'b7', '7'];
                        const data = labels.map(l => {
                            const id = Object.keys(DEGREE_EXPLANATIONS).find(k => { const map = {0:'R',3:'b3',4:'3',7:'5',10:'b7',11:'7'}; return map[k] === l; });
                            const s = stats.degree[id]; return s ? Math.round((s.correct/s.attempts)*100) : 0;
                        });
                        if(charts.deg) charts.deg.destroy();
                        charts.deg = new Chart(ctxDeg, {
                            type: 'radar',
                            data: { labels: labels, datasets: [{ label: 'Accuracy %', data: data, backgroundColor: 'rgba(149, 53, 58, 0.2)', borderColor: '#95353a' }] },
                            options: { scales: { r: { min: 0, max: 100, grid: {color:'#333'}, angleLines: {color:'#333'}, pointLabels:{color:'#aaa'} } } }
                        });
                        const ctxShp = document.getElementById('shapeChart');
                        const sLabels = ['C','A','G','E','D'];
                        const sData = sLabels.map(l => { const s = stats.shape[l]; return s ? Math.round((s.correct/s.attempts)*100) : 0; });
                        if(charts.shp) charts.shp.destroy();
                        charts.shp = new Chart(ctxShp, {
                            type: 'bar',
                            data: { labels: sLabels, datasets: [{ label: 'Mastery %', data: sData, backgroundColor: '#4a6fa5' }] },
                            options: { scales: { y: { beginAtZero: true, max: 100, grid:{color:'#333'} } } }
                        });
                    });
                }
            });

            const exportData = () => {
                const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `caged_jazz_${Date.now()}.json`; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (res) => { localStorage.setItem(STORAGE_KEY, res.target.result); location.reload(); };
                reader.readAsText(file);
            };
            const resetData = () => {
                if(confirm('Reset all progress? This cannot be undone.')) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
            };

            window.addEventListener('keydown', (e) => {
                if (currentView.value === 'game') {
                    if (e.key === 'Escape') endSession();
                    if (e.key === 'h' || e.key === 'H') {
                        if (difficulty.value === 'easy') {
                            fretboardDots.value.forEach(d => { if(d.isRoot) d.showLabel = true; });
                        }
                    }
                    if ((e.key === 'n' || e.key === 'N') && gameMode.value === 'song') {
                         songIndex.value = (songIndex.value + 1) % currentSong.value.chords.length;
                         nextQuestion();
                    }
                } else if (currentView.value === 'title') {
                    if (e.key === 'K' && e.shiftKey) { selectedKey.value = selectedKey.value==='ALL'?'C':'ALL'; }
                }
            });

            onMounted(loadData);

            return {
                currentView, difficulty, selectedKey, selectedShape, keysList,
                startGame, startSongMode, endSession, handleShot,
                sessionScore, combo, comboMultiplier, currentRankInfo,
                timerWidth, timerColor, feedback, fretboardDots, displayRange, currentQuestion, theoryTip,
                stats, achievements, unlockedBadgeCount, showAchievements,
                showAnalysis, openAnalysis, analysisTab, playHistory,
                showSettings, settings, exportData, importData, resetData,
                dailyMission, srsDueCount, showHelp, showRankUp,
                showSongSelect, filteredSongs, searchQuery, getHeatmapColor,
                currentSong, songIndex, gameMode, nextChordName, statsOverview,
                revealed, ingameRankUp // EXPOSE NEW STATES
            };
        }
    }).mount('#app');
</script>
</body>
</html>